#!/usr/bin/env sh

set -o errexit

__NIX_PACKAGE_LIST="${__NIX_PACKAGE_LIST:-packages}"
__NIX_PROFILE_DIR="${XDG_STATE_HOME:-${HOME}/.local/state}/nix/profiles"
__NIX_PROFILE_NAME="${__NIX_PROFILE_NAME:-development}"
__NIX_PROFILE_PATH="${__NIX_PROFILE_DIR}/${__NIX_PROFILE_NAME}"

__die() {
    printf '%s\n' "$@" >&2
    printf '%s\n' "Dying..."
    return 1
}

__nix_add_channels() {
    # Ensures the prerequisite nix channels are present     

    found_stable=0
    found_unstable=0

    while IFS= read -r line; do
        set -- $line
        case "$1" in
            "nixpkgs")
                found_stable=1
                ;;
             "nixpkgs-unstable")
                found_unstable=1
                ;;
        esac
    done <<< $(nix-channel --list)

    [ $found_stable -ne 1 ] &&  __die "Could not find channel 'nixpkgs'"
    [ $found_unstable -ne 1 ] || nix-channel --add https://nixos.org/channels/nixpkgs-unstable nixpkgs-unstable
}

__nix_packages() {
    # Reads in a flat file and installs the corresponding nix package

    action="${1:-install}"
    while IFS= read -r line; do
        case "$line" in
            "#"*|"")
                continue
                ;;        
        esac

        IFS='#' read -r channel package <<< "$line"
        set -- $channel $package
        if [ $# -eq 1 ]; then
             package="$1"
             channel="nixpkgs"
        fi

        NIXPKGS_ALLOW_UNFREE=1 nix profile "$action" --impure --profile $__NIX_PROFILE_PATH "${channel}#${package}"
    done < "$__NIX_PACKAGE_LIST"
}

__nix_switch_profile() {
    nix-env --switch-profile $__NIX_PROFILE_NAME
}

__nix_add_shortcuts() {
    for f in ~/.nix-profile/Applications/*; do
        ln -svf "$f" ~/Applications/
    done
}

main() {
    __nix_add_channels

    [ -z "$1" ] && set -- upgrade 
    while [ $# -gt 0 ]; do
        case "$1" in
            "install")
                __nix_packages install
                ;;
            "upgrade")
                __nix_packages upgrade
                ;;
            *)
                __die "Unrecognized command: $1"
        esac
        shift
    done 

    __nix_switch_profile
    __nix_add_shortcuts
}

main "$@"
